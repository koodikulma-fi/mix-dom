import{ContextAPI as e,mixinSignalMan as t,callListeners as o,SignalBoy as n,askListeners as s,RefreshCycle as r}from'data-signals';import{cleanDOMProps as i,readDOMProps as d,applyDOMProps as a,createDOMElement as l,readDOMString as c,equalDOMProps as u,getDictionaryDiffs as f}from'dom-types';import{areEqualBy as p,CompareDepthEnum as h,areEqual as m,orderedIndex as g}from'data-memo';class BaseBoundary{constructor(e,t,o){this.host=e,this.treeNode=o,this._outerDef=t,this._innerDef=null,this.isMounted=!1,this.sourceBoundary=null,this.parentBoundary=null,this.innerBoundaries=[]}}function treeNodesWithin(e,t,o=0,n=!1,s=!1,r){const i=[];let d,a=[e],l=0;const c=e.boundary;for(;d=a[l];)if(l++,!d.boundary||null!==d.boundary.isMounted){if((!t||t.has(d.type))&&(!r||r(d))){const e=i.push(d);if(o&&e>=o)return i}d.boundary&&!n&&d.boundary!==c||('host'!==d.type||s)&&d.children[0]&&(a=d.children.concat(a.slice(l)),l=0)}return i}function rootDOMTreeNodes(e,t=!1,o=!1,n=0){let s=[];for(const r of e.children)if(r.domNode||o)switch(r.type){case'dom':if(s.push(r),n&&s.length>=n)return s;break;case'boundary':case'pass':case'host':if(!t)break;case'root':if(s=s.concat(rootDOMTreeNodes(r,t,o,n&&n-s.length)),n&&s.length>=n)return s.slice(0,n)}return s}function allDefsIn(e,t=!1){var o,n;const s=[];let r,i=[e],d=0;for(;r=i[d++];)r.updateId&&t&&r.updateId===(null===(n=null===(o=r.treeNode)||void 0===o?void 0:o.sourceBoundary)||void 0===n?void 0:n.host.services._whileUpdating)||s.push(r),r.childDefs[0]&&(i=r.childDefs.concat(i.slice(d)),d=0);return s}function domElementByQuery(e,t,o=!1,n=!1){const s=treeNodesWithin(e,new Set(['dom']),1,o,n,(e=>e.domNode&&e.domNode instanceof Element&&e.domNode.matches(t)))[0];return s&&s.domNode||null}function domElementsByQuery(e,t,o=0,n=!1,s=!1){return treeNodesWithin(e,new Set(['dom']),o,n,s,(e=>e.domNode&&e.domNode instanceof Element&&e.domNode.matches(t))).map((e=>e.domNode))}var __rest=function(e,t){var o={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(o[n]=e[n]);if(null!=e&&'function'==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(e);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(o[n[s]]=e[n[s]])}return o};const y={};function newDef(e,t=null,...o){const n=function parseDefType(e){if('string'==typeof e)return'_'===e?'element':'dom';if(!e)return'';const t=e.MIX_DOM_CLASS;if(!t)return'function'==typeof e?e.length>=2?'boundary':'spread':'';switch(t){case'Component':case'Remote':return'boundary';case'Fragment':case'Portal':case'Element':case'Host':return t.toLowerCase();default:return''}}(e);if(!n||t&&t._disable)return null;const s=[];let r=!1,d=0;for(const e of o){let t='string'==typeof e;if(e&&t&&r){s[d-1].domContent+=e;continue}const o=newDefFrom(e);o&&(d=s.push(o),r=t)}if('spread'===n)return function unfoldSpread(e,t,o){var n;const{_key:s,_disable:r}=t,i=__rest(t,['_key','_disable']);let d=newDefFrom(e(i));if(!d)return null;const a={passes:[],withs:[]},l={MIX_DOM_DEF:'fragment',childDefs:[Object.assign({},d)],scopeType:'spread',spreadLinks:a,tag:null};null!=s&&(l.key=s);null!=r&&(l.disabled=r);let c,u=[l],f=!1,p=0;const h=!!o[0];for(;c=u[p];){if(p++,!c.childDefs[0])continue;let e=[];const t=c.childDefs;c.childDefs=[];for(const s of t){let t;if(s.spreadLinks){t=s,e=e.concat(s.spreadLinks.passes);for(const[e,t]of s.spreadLinks.withs){const o=e&&hasContentInDefs(e,h);t.props.hasContent=!!o,'maybe'===o&&a.withs.push([e,t])}}else if('pass'===s.MIX_DOM_DEF)s.getRemote?t=s:(t={MIX_DOM_DEF:'fragment',tag:null,childDefs:[...o]},null!=s.key&&(t.key=s.key),f||'copy'===s.contentPassType?t.scopeType='spread-copy':(t.scopeType='spread-pass',f=!0),a.passes.push(t));else if(t=Object.assign({},s),e.push(t),'boundary'===s.MIX_DOM_DEF&&s.tag._WithContent&&!s.tag._WithContent.getRemote&&!s.tag.withContents&&null==(null===(n=t.props)||void 0===n?void 0:n.hasContent)){const e=hasContentInDefs(o,h);t.props=Object.assign({hasContent:!!e},t.props),'maybe'===e&&a.withs.push([o,t])}c.childDefs.push(t)}u=e.concat(u.slice(p)),p=0}return l}(e,t||{},s);if('fragment'===n&&!s[0])return null;const a='dom'===n&&e||'boundary'===n&&e||'element'===n&&'_'||('content'===n?'':null),l={MIX_DOM_DEF:n,tag:a,childDefs:s};if('fragment'===l.MIX_DOM_DEF);else if(t){const{_key:e,_ref:o,_signals:s,_contexts:r,_disable:d}=t,c=__rest(t,['_key','_ref','_signals','_contexts','_disable']);if(null!=e&&(l.key=e),o){const e=[];if('Ref'===o.constructor.MIX_DOM_CLASS)e.push(o);else for(const t of o)t&&'Ref'===t.constructor.MIX_DOM_CLASS&&-1===e.indexOf(t)&&e.push(t);l.attachedRefs=e}s&&(l.attachedSignals=Object.assign({},s)),r&&'boundary'===n&&(l.attachedContexts=Object.assign({},r)),a&&(l.props='string'==typeof a?i(c):c)}else a&&(l.props={});switch(l.MIX_DOM_DEF){case'portal':l.domPortal=t.container||null;break;case'element':{const e=l.props||{},{element:t,cloneMode:o}=e,n=__rest(e,['element','cloneMode']);l.props=i(n),l.domElement=t||null,l.domCloneMode=null!=o?'boolean'==typeof o?o?'deep':'':o:null;break}}return l}function newDefHTML(e,t,o,n){const s={MIX_DOM_DEF:'content',tag:t||'',childDefs:[],domContent:e,domHTMLMode:!0};return t&&o&&(s.props=i(o)),null!=n&&(s.key=n),s}function newDefFrom(e){if(e&&'object'==typeof e){if('string'==typeof e.MIX_DOM_DEF)return e;if(e instanceof Node)return{MIX_DOM_DEF:'content',tag:'',childDefs:[],domContent:e};if('Host'===e.constructor.MIX_DOM_CLASS)return{MIX_DOM_DEF:'host',tag:null,host:e,key:e,childDefs:[]};if(Array.isArray(e)||e instanceof HTMLCollection||e instanceof NodeList){const t=[...e].map((e=>newDefFrom(e))).filter((e=>e));return t.length?{MIX_DOM_DEF:'fragment',tag:null,isArray:!0,childDefs:t}:null}e=String(e)}return null!=e?{MIX_DOM_DEF:'content',tag:'',domContent:e,childDefs:[]}:null}function newAppliedDef(e,t){const o={MIX_DOM_DEF:e.MIX_DOM_DEF,tag:e.tag,childDefs:[],action:'mounted'};return null!=e.key&&(o.key=e.key),'fragment'===o.MIX_DOM_DEF?(e.isArray&&(o.isArray=!0),e.scopeType&&(o.scopeType=e.scopeType)):'pass'===o.MIX_DOM_DEF?e.getRemote?(o.getRemote=e.getRemote,o.contentPass=e.contentPass||null):o.contentPass=e.contentPass||t||null:e.host&&(o.host=e.host),o}function newContentPassDef(e,t){const o={MIX_DOM_DEF:'pass',tag:null,childDefs:[],contentPassType:t?'copy':'pass'};return null!=e?o.key=e:t||(o.key=y),o}function hasContentInDefs(e,t){let o=!1;for(const n of e){if(n.disabled)continue;const e='fragment'===n.MIX_DOM_DEF?hasContentInDefs(n.childDefs,t):'pass'!==n.MIX_DOM_DEF||('function'==typeof t?t(n):t&&'maybe');if(e){if(!0===e)return!0;o='maybe'}}return o}class ContentClosure{constructor(e,t){this.thruBoundary=e||null,this.sourceBoundary=t||null,this.envelope=null,this.truePassDef=null,this.groundedDefs=new Map,this.pendingDefs=new Set}hasContent(){var e;return!(!(null===(e=this.envelope)||void 0===e?void 0:e.applied)||!hasContentInDefs(this.envelope.applied.childDefs,!1))}readContent(e=!1){if(!this.envelope)return null;const t=this.envelope.applied,o=t.childDefs;if('fragment'===t.MIX_DOM_DEF&&(!o.length||o[0].disabled&&1===o.length))return null;const n=this.envelope.target.childDefs;return e?n.slice():n}}class ComponentContextAPI extends e{getContext(e,t=!0){return void 0!==this.contexts[e]?this.contexts[e]:t?this.host.contextAPI.contexts[e]:void 0}getContexts(e,t=!0,o=!1){return t?Object.assign(Object.assign({},this.host.contextAPI.getContexts(e,o)),super.getContexts(e,o)):super.getContexts(e,o)}afterRefresh(e=!1,t,o){return e?(this.host.triggerRefresh(t,o),this.awaitDelay()):this.host.afterRefresh(!1,t,o)}awaitDelay(){return this.host.afterRefresh(!0)}}function mixinComponent(e){var o;return(o=class Component extends(t(e)){constructor(e,t,...o){super(...o),this.props=e,t&&(this.boundary=t,t.component=this)}initContextAPI(){if(this.contextAPI)return;this.contextAPI=new ComponentContextAPI,this.contextAPI.host=this.boundary.host,this.boundary.host.contextComponents.add(this);const e=this.boundary._outerDef.attachedContexts;if(e)for(const t in e)this.contextAPI.setContext(t,e[t],!1)}isMounted(){return!0===this.boundary.isMounted}getLastState(e=!0){return this.lastState||e&&this.state||null}getHost(){return this.boundary.host}queryElement(e,t=!1,o=!1){return domElementByQuery(this.boundary.treeNode,e,t,o)}queryElements(e,t=0,o=!1,n=!1){return domElementsByQuery(this.boundary.treeNode,e,t,o,n)}findElements(e=0,t=!1,o=!1,n){return treeNodesWithin(this.boundary.treeNode,new Set(['dom']),e,t,o,n).map((e=>e.domNode))}findComponents(e=0,t=!1,o=!1,n){return treeNodesWithin(this.boundary.treeNode,new Set(['boundary']),e,t,o,n).map((e=>e.boundary&&e.boundary.component))}findTreeNodes(e,t=0,o=!1,n=!1,s){const r=e?e.constructor===Set?e:e.constructor===Array?new Set(e):new Set(Object.keys(e)):void 0;return treeNodesWithin(this.boundary.treeNode,r,t,o,n,s)}setTimer(e,t,o){return null==e&&(e={}),this.timers?this.timers.has(e)&&this.clearTimers(e):this.timers=new Map,this.timers.set(e,setTimeout((()=>{this.clearTimers(e),t.call(this)}),o)),e}hasTimer(e){return!!this.timers&&this.timers.has(e)}clearTimers(...e){if(this.timers)if(e.length)for(const t of e){const e=this.timers.get(t);null!=e&&(clearTimeout(e),this.timers.delete(t))}else this.timers.forEach((e=>clearTimeout(e))),this.timers.clear()}setUpdateModes(e,t=!0){t&&this.updateModes||(this.updateModes={});for(const t in e)this.updateModes[t]=e[t]}setConstantProps(e,t=!0,o=null){var n,s;t&&this.constantProps||(this.constantProps={});let r=!1;if(e)if(Array.isArray(e))for(const t of e)this.constantProps[t]=null===(n=(r=!0)&&o)||void 0===n||n;else for(const t in e)this.constantProps[t]=null!==(s=(r=!0)&&o)&&void 0!==s?s:e[t];r||t||delete this.constantProps}setState(e,t,o,n){this.boundary.updateBy({state:Object.assign(Object.assign({},this.state),e)},t,o,n)}setInState(e,t,o,n,s){this.boundary.updateBy({state:Object.assign(Object.assign({},this.state),{[e]:t})},o,n,s)}triggerUpdate(e,t,o){this.boundary.host.services.absorbUpdates(this.boundary,{force:e||!1},!0,t,o)}addWired(e){this.wired?this.wired.add(e):this.wired=new Set([e])}removeWired(e){var t;null===(t=this.wired)||void 0===t||t.delete(e)}afterRefresh(e=!1,t,o){return e?(this.boundary.host.triggerRefresh(t,o),this.awaitDelay()):this.boundary.host.afterRefresh(!1,t,o)}awaitDelay(){return this.boundary.host.afterRefresh(!0)}render(e,t){return null}}).MIX_DOM_CLASS='Component',o}class Component extends(mixinComponent(Object)){constructor(e,t){super(e,t)}}function createComponent(e,...t){const o=t[0]&&'object'==typeof t[0]?t[0]:void 0,n=(o?t[1]:t[0])||e.name,s={[n]:e.length>1?function(t,o,n){return e(o,n)}:function(t,o){return e(o)}}[n];if(o)for(const e in o)s[e]=o[e];return s}function createComponentCtx(e,...t){const o=t[0]&&'object'==typeof t[0]?t[0]:void 0,n=(o?t[1]:t[0])||e.name,s={[n]:function(t,o,n){return e(o,n)}}[n];if(o)for(const e in o)s[e]=o[e];return s}class SourceBoundary extends BaseBoundary{constructor(e,t,o,n){super(e,t,o),this.bId=e.services.createBoundaryId(),this.sourceBoundary=n||null,this.closure=new ContentClosure(this,n)}reattach(){this.component=null;const e=this._outerDef.props||{};let t=this._outerDef.tag;if('function'==typeof t){const n=t.api,s=t.MIX_DOM_CLASS?null:this._outerDef.tag,r=s&&s.length>=3||!1,i=this.component=new(s?n?{[s.name]:class extends Component{}}[s.name]:Component:t)(e,this);if(this.component=i,r&&i.initContextAPI(),s&&(i.render=r?e=>s.call(i,e,i,i.contextAPI):e=>s.call(i,e,i)),i.boundary||(i.boundary=this),n){i.constructor.api=n,n.components.add(i);for(const e in n.signals)for(const t of n.signals[e]){const[o,n,s]=t;i.listenTo(e,((...e)=>n?o(i,...e,...n):o(i,...e)),null,s,o)}}'Remote'===t.MIX_DOM_CLASS&&(this.closure.remote=i,t.addSource(i)),i.signals.preMount&&o(i.signals.preMount)}else this.component=new Component(e,this)}update(e,t,o){this.host.services.absorbUpdates(this,{force:this.isMounted?e||!1:'all'},!0,t,o)}updateBy(e,t,o,n){this.host.services.absorbUpdates(this,Object.assign(Object.assign({},e),{force:this.isMounted?t||!1:'all'}),!0,o,n)}render(e=0){const t=!1===this.isMounted&&!this._renderState;e||(this._renderState='active');const o=this.component,n=o.render(o.props||{},o.state),s='function'==typeof n;if(s&&(o.render=n),t&&o.contextAPI&&o.contextAPI.callDataBy(),s)return this.render(e);if('re-updated'===this._renderState){const t=this.host.settings;if(t.maxReRenders<0||e<t.maxReRenders)return e++,this._renderState='active',this.render(e);t.debugMode&&console.warn('__SourceBoundary.render: Warning: The component tried to render for over '+(e+1).toString()+' times.',this._outerDef.tag.MIX_DOM_CLASS?o.constructor:this._outerDef.tag,o)}return delete this._renderState,n}}const C=newContentPassDef(),D=newContentPassDef({},!0);class Ref extends n{constructor(...e){super(...e),this.treeNodes=new Set}getTreeNode(){return[...this.treeNodes][this.treeNodes.size-1]||null}getTreeNodes(){return[...this.treeNodes]}getElement(e=!1){let t=this.treeNodes.size-1;const o=[...this.treeNodes];for(;t>=0;){const n=o[t];if(n.domNode&&(!e||'dom'===n.type))return n.domNode}return null}getElements(e=!1){let t=[];for(const o of this.treeNodes)o.domNode&&('dom'===o.type?t.push(o.domNode):e||(t=t.concat(rootDOMTreeNodes(o,!0).map((e=>e.domNode)))));return t}getComponent(){var e;const t=[...this.treeNodes][this.treeNodes.size-1];return t&&'boundary'===t.type&&(null===(e=t.boundary)||void 0===e?void 0:e.component)||null}getComponents(){var e;const t=[];for(const o of this.treeNodes)'boundary'===o.type&&(null===(e=o.boundary)||void 0===e?void 0:e.component)&&t.push(o.boundary.component);return t}static onListener(e,t,o,n){if(e.treeNodes.size&&e.signals[t]){const s=e.signals[t][o],r=s[0];if(n)for(const o of e.getComponents())o.listenTo(t,((...e)=>s[1]?r(o,...e,...s[1]):r(o,...e)),null,s[2],r);else for(const o of e.getComponents())o.unlistenTo(t,r)}}static didAttachOn(e,t){var n;if(!e.treeNodes.has(t))if(e.treeNodes.add(t),'boundary'===t.type){const s=null===(n=t.boundary)||void 0===n?void 0:n.component;for(const t in e.signals)for(const o of e.signals[t]){const[e,n,r]=o;s.listenTo(t,((...t)=>n?e(s,...t,...n):e(s,...t)),null,r,e)}s&&e.signals.didAttach&&o(e.signals.didAttach,[s])}else'dom'===t.type&&t.domNode&&e.signals.domDidAttach&&o(e.signals.domDidAttach,[t.domNode])}static willDetachFrom(e,t){var n;if(e.treeNodes.has(t))if('boundary'===t.type){const s=null===(n=t.boundary)||void 0===n?void 0:n.component;if(s){e.signals.willDetach&&o(e.signals.willDetach,[s]);for(const t in e.signals)for(const o of e.signals[t])s.unlistenTo(t,o[0])}}else'dom'===t.type&&t.domNode&&e.signals.domWillDetach&&o(e.signals.domWillDetach,[t.domNode]);e.treeNodes.delete(t)}}Ref.MIX_DOM_CLASS='Ref';const createSpread=e=>e.length>1?function(t,...o){return e(t,...o)}:e,createSpreadWith=e=>e.length>1?function(t,...o){return e(t,...o)}:e;class HostContextAPI extends e{setContext(e,t,o=!0,n=!1){return n&&(t?this.host.shadowAPI.contexts[e]=t:delete this.host.shadowAPI.contexts[e]),super.setContext(e,t,o)}setContexts(e,t=!0,o=!1){if(o){const t=this.host.shadowAPI.contexts;for(const o in e)e[o]?t[o]=e[o]:delete t[o]}return super.setContexts(e,t)}awaitDelay(){return this.host.services.renderCycle.promise}afterRefresh(e,t,o){return this.host.services.triggerRefresh(t,o),e?this.awaitDelay():this.host.services.updateCycle.promise}static getListenersFor(e,t,o){const n=t+'.'+(o||''),s=[...e.host.contextComponents];if(!o){let o=[];for(const t in e.signals)t.startsWith(n)&&(o=o.concat(e.signals[t]));return o.concat(s.reduce(((e,o)=>{if(void 0!==o.contextAPI.contexts[t])return e;const s=o.contextAPI.signals;for(const t in s)t.startsWith(n)&&(e=e.concat(s[t]));return e}),[]))}const r=(e.signals[n]||[]).concat(s.filter((e=>e.contextAPI.signals[n]&&void 0===e.contextAPI.contexts[t])).map((e=>e.contextAPI.signals[n])).reduce(((e,t)=>e.concat(t)),[]));return r[0]&&r}static callDataListenersFor(t,o=!0){if(t.callDataBy(o,!0),t.host.contextComponents.size){const n=e.readContextNamesFrom(!0===o?Object.keys(t.contexts):o);for(const e of t.host.contextComponents)n.some((t=>void 0===e.contextAPI.contexts[t]))&&e.contextAPI.callDataBy(o)}}}class ContentBoundary extends BaseBoundary{constructor(e,t,o,n){super(n.host,e,o),this.sourceBoundary=n,this.targetDef=t,this._innerDef=newAppliedDef(t,n.closure)}updateEnvelope(e,t){this.targetDef=e,t&&(this._innerDef.childDefs=t.childDefs)}}class HostShadowAPI{constructor(){this.hosts=new Set,this.contexts={}}}class HostRender{constructor(e,t){this.assimilationRoot=t||null,this.paused=e.disableRendering,this.settings=e,this.externalElements=new Set,this.inBrowser='object'==typeof document}pause(){this.paused=!0}resume(){this.paused&&(this.paused=!1,this.assimilationRoot&&this.reassimilate(null,!0))}reassimilate(e=null,t=!1,o=!1,n=!1,s,r){var i;const a=this.assimilationRoot;if(!a)return void(this.settings.debugMode&&console.warn('__HostRender.reassimilate: Warning: No assimilation root assigned. ',this));const l=e?HostRender.createVirtualItemsFor(e):{};l.validator=s,l.suggester=r;const c=l.reused=new Set(e?[...this.externalElements,e]:this.externalElements),u=[];for(const[e,,n]of HostRender.getVirtualDomPairs(a,l,!1)){let s=e.domNode;!n||e.domNode&&!o||(s=n),s&&c.add(s);const r={treeNode:e};let i=t;if(s!==e.domNode&&(i=!0,e.domNode?s&&(r.swap=s):r.create=!0),!r.create&&s){const[t,o]=HostRender.findInsertionNodes(e);s.parentNode===t&&s.nextSibling===o||(r.move=!0),'content'===e.def.MIX_DOM_DEF?r.content=!0:(i&&(e.domProps=d(s)),r.update=!0)}(r.create||r.swap||r.move||r.update||r.content)&&u.push(r)}if(n&&e){let t,o=e===a.domNode?rootDOMTreeNodes(a.children[0],!0).map((e=>e.domNode)).filter((e=>e)):[...e.childNodes],n=0;for(;t=o[n];)n++,c.has(t)?t.childNodes[0]&&(o=[...t.childNodes,...o.slice(n)],n=0):null===(i=t.parentNode)||void 0===i||i.removeChild(t)}if(this.settings.disableRendering||(this.paused=!1),u[0]&&this.applyToDOM(u),this.pausedPending){const e=this.pausedPending.filter((e=>e.treeNode.domNode&&!c.has(e.treeNode.domNode)));delete this.pausedPending,e[0]&&this.applyToDOM(e)}}applyToDOM(e){var t;const n=this.sourceRemount;if(n&&this.assimilationRoot&&HostRender.onRemount(n,this.assimilationRoot),this.paused){const t=e.filter((e=>e.remove));return void(t[0]&&(this.pausedPending=(this.pausedPending||[]).concat(t)))}const r=this.settings;let i=null,l=null,c=null,u=null;for(const f of e){const e=f.treeNode,p=e.def.attachedSignals,h=e.def.attachedRefs;if(f.remove){if('dom'===e.type&&e.domNode){const t=e.domNode,o=t.parentNode;let n=!1;if((null==p?void 0:p.domWillUnmount)&&p.domWillUnmount(t)&&(n=!0),h)for(const o of h)o.signals.domWillUnmount&&s(o.signals.domWillUnmount,[t],['no-false','last'])&&(n=!0),Ref.willDetachFrom(o,e);n?c?c.push(t):c=[t]:!o||l&&-1!==l.indexOf(o)||c&&c.some((e=>e.contains(t)))||o.removeChild(t);const r='element'===e.def.MIX_DOM_DEF;(r||'content'===e.def.MIX_DOM_DEF)&&this.externalElements.delete(t),r||(l||(l=[])).push(t),e.domNode=null,HostRender.updateDOMChainBy(e,null)}continue}let m=!1,g=0;if(f.refresh&&e.domNode&&e.domProps&&(e.domProps='read'===f.refresh?d(e.domNode):{},m=!0),f.create)if(e.domNode)g=!n||e.domNode.nodeType!==Node.TEXT_NODE||!0!==n.readFromDOM&&'content'!==n.readFromDOM?2:3;else switch(e.type){case'dom':const t=this.createDOMNodeBy(e);t&&(e.domNode=t,g=1,n&&n.created&&n.created.add(t));break;case'portal':e.domNode=e.def.domPortal||null}if(g||f.move)if('host'===e.type){const t=e.def.host||null;t&&t.services.refreshRoot(!1,null,null),e.domNode=e.parent&&t&&t.getRootElement()||null,HostRender.updateDOMChainBy(e,e.domNode)}else e.domNode&&(g<2||!e.domNode.parentElement?(i||(i=[])).push(f):((e.def.attachedRefs||e.def.attachedSignals)&&(u||(u=[])).push([!0,f.treeNode,e.domNode.parentElement,e.domNode.nextSibling]),HostRender.updateDOMChainBy(e,e.domNode)));if(f.swap){const o=!0!==f.swap,n=e.domNode;let s=o?f.swap:('portal'===e.type?e.def.domPortal:e.def.domElement)||null;if(n!==s){if(!o&&'dom'===e.type){const o=e,i=n&&n.parentNode;if(s&&(s=this.getApprovedNode(s,o),s)){let[t,o]=i?[i,n]:HostRender.findInsertionNodes(e);t&&t.insertBefore(s,o)}if(n){if(this.externalElements.delete(n),(null===(t=o.domProps)||void 0===t?void 0:t.listeners)&&n instanceof Element){const e=o.domProps.listeners;for(const t in e)e[t]&&n.removeEventListener(t,e[t])}i&&i.removeChild(n)}o.domProps&&(o.domProps=s&&'read'===r.renderDOMPropsOnSwap?d(s):{},m=!0)}for(const t of e.children){const e=t.domNode;e&&(e.parentNode&&e.parentNode.removeChild(e),s&&s.appendChild(e))}e.domNode=s,HostRender.updateDOMChainBy(e,s)}}if((f.content||3===g)&&'dom'===e.type&&e.domNode){const t=e.def.domContent,n=e.domNode;let s=n;if('content'===e.def.MIX_DOM_DEF){if(e.def.domHTMLMode&&null!=t&&''!==t)s=HostRender.domNodeFrom(t.toString(),e.def.tag||r.renderHTMLDefTag,!0),s&&e.domProps&&(m=!0,e.domProps={});else{const e=null==t?'':(r.renderTextHandler?r.renderTextHandler(t):t).toString();n.nodeType!==Node.TEXT_NODE&&this.inBrowser?s=document.createTextNode(e):n.textContent=e}}else if(t instanceof Node){const e=t.parentNode;e&&e.removeChild(t)}else n.textContent='';if(s&&n!==s){const t=n.parentNode;t&&(e.domNode=s,t.insertBefore(s,n),t.removeChild(n)),HostRender.updateDOMChainBy(e,e.domNode)}if((null==p?void 0:p.domDidContent)&&p.domDidContent(e.domNode,null!=t?t:null),h)for(const n of h)n.signals.domDidContent&&o(n.signals.domDidContent,[e.domNode,null!=t?t:null])}if((g||m||f.update)&&'dom'===e.type){const t=e.domNode instanceof Element?e.domNode:null,n=e.def.props||{},s=a(e.domNode instanceof Element?e.domNode:null,n,e.domProps||{},r.debugMode);if(e.domProps=n,s&&f.update&&t&&((null==p?void 0:p.domDidUpdate)&&p.domDidUpdate(t,s),h))for(const e of h)e.signals.domDidUpdate&&o(e.signals.domDidUpdate,[t,s])}f.emptyMove&&HostRender.updateDOMChainBy(e,null,!0)}if(i){const e=[];let t=i.length;for(;t--;){const o=i[t],n=o.treeNode,s=n.domNode;if(s){const t=s.parentNode,r=s.nextSibling,[i,d]=s?HostRender.findInsertionNodes(n):[null,null];i===t&&d===r||(i&&e.push([s,i,d]),(n.def.attachedRefs||n.def.attachedSignals)&&(u||(u=[])).push([!o.move,o.treeNode,t,r]),t&&t.removeChild(s))}HostRender.updateDOMChainBy(n,s)}if(e[0])for(const t of e)t[1].insertBefore(t[0],t[2])}if(u){let e=u.length;for(;e--;){const[t,n,s,r]=u[e],{attachedSignals:i,attachedRefs:d}=n.def,a=n.domNode;if(i&&(t?i.domDidMount&&i.domDidMount(a):i.domDidMove&&i.domDidMove(a,s,r)),d)for(const e of d)t?(Ref.didAttachOn(e,n),e.signals.domDidMount&&o(e.signals.domDidMount,[a])):e.signals.domDidMove&&o(e.signals.domDidMove,[a,s,r])}}}getApprovedNode(e,t){let o=e;const n=null!=t.def.domCloneMode?t.def.domCloneMode:this.settings.duplicateDOMNodeBehaviour;return('always'===n||this.externalElements.has(e))&&(o=this.settings.duplicateDOMNodeHandler?this.settings.duplicateDOMNodeHandler(e,t):n?e.cloneNode('deep'===n||'always'===n):null),o&&this.externalElements.add(o),o}createDOMNodeBy(e){var t;const o=e.def.tag;if('string'!=typeof o)return null;if('_'===o)return e.def.domElement&&this.getApprovedNode(e.def.domElement,e)||null;const n=e.def.domContent;if(n instanceof Node)return this.getApprovedNode(n,e);const s=this.settings;if(e.def.domHTMLMode&&null!=n&&''!==n)return HostRender.domNodeFrom(n.toString(),o||s.renderHTMLDefTag,!0);if(o)return this.inBrowser?l(o,null===(t=e.parent)||void 0===t?void 0:t.domNode,s.renderSVGNamespaceURI):null;let r=null,i='',d='';if(null!=n){d=(s.renderTextHandler?s.renderTextHandler(n):n).toString();const e=s.renderTextTag;if(e)if('string'==typeof e)i=e;else if('function'==typeof e){const t=e(n);t instanceof Node&&(r=t)}}if(!r){if(!this.inBrowser)return null;r=i?document.createElement(i):document.createTextNode(d)}return i&&d&&(r.textContent=d),r}static findInsertionNodes(e){let t=null,o=e.parent;for(;o;){if(!(HostRender.PASSING_TYPES[o.type]||'root'===o.type&&o.parent)){t=o.domNode;break}o=o.parent}if(!t)return[null,null];let n=null,s=e;for(;s&&(o=s.parent,o);){let e,r=o.children.indexOf(s)+1;for(;e=o.children[r];){if(e.domNode&&'portal'!==e.type){n=e.domNode;break}r++}if(n||o.domNode===t)break;s=o}return[t,n]}static updateDOMChainBy(e,t,o=!1){let n=e,s=o?e:e.parent,r=t;for(;s&&(HostRender.PASSING_TYPES[s.type]||s===n);){if(s.children[0]!==n&&s!==n){let e=!1,t=s.children.indexOf(n)-1;for(;t>=0;){if(s.children[t].domNode){e=!0;break}t--}if(e)break}if(!r){let e,t=s.children.indexOf(n)+1;for(;e=s.children[t];){if(e.domNode&&'portal'!==e.type){r=e.domNode;break}t++}if(r&&s.domNode===r)break}s.domNode=r,n=s,s=s.parent}}static domNodeFrom(e,t='div',o=!1){const n=t instanceof Element?t:'object'==typeof document?document.createElement(t):null;return n?(n.innerHTML=e,o||n.children[1]?n:n.children[0]):null}static readDOMString(e,t=['img']){const o=e.def;if(!o)return'';let n=o.tag,s='';if('string'!=typeof n){if(e.children)for(const o of e.children)s+=HostRender.readDOMString(o,t);return s}let r=null;if(n)'_'===n&&(n='',r=o.domElement||null);else{const e=o.domContent;e&&(e instanceof Node?r=e:s+=e.toString())}return n||r?(s+=c(n,e.domProps,(null!=o.domContent?o.domContent instanceof Node?c('',null,null,o.domContent):o.domContent.toString():'')+(e.children?e.children.reduce(((e,o)=>e+HostRender.readDOMString(o,t)),''):'')||t&&!t.includes(n),r||((null==o?void 0:o.domContent)instanceof Node?o.domContent:null)),s):s}static onRemount(e,t){let{reused:o,readFromDOM:n}=e;o||(o=new Set),t.domNode&&o.add(t.domNode);for(const[s,r,i]of HostRender.getVirtualDomPairs(t,e,!0)){if(!0!==n&&'attributes'!==n||(s.domProps=d(i)),s.domNode=i,o.add(i),s.def.domHTMLMode&&r)for(const e of HostRender.flattenVirtualItems(r))o.add(e.node);if(i.parentElement){let e=s;for(;e=e.parent;)if('dom'===e.type){i.parentElement!==e.domNode&&i.parentElement.removeChild(i);break}}}if(e.vRoot)for(const t of HostRender.flattenVirtualItems(e.vRoot)){if(o.has(t.node))continue;const n=t.node;e.unused&&e.unused.add(n),e.removeUnused&&n.parentElement&&n.parentElement.removeChild(n)}}static createVirtualItemsFor(e){var t,o;let n=null;const s={};if(n={tag:(null===(t=e.tagName)||void 0===t?void 0:t.toLowerCase())||'',node:e,parent:null},e.childNodes[0]){let t,r=[[[...e.childNodes],n]],i=0;for(;t=r[i];){i++;const[e,n]=t;n.children||(n.children=[]);let d=[];for(const t of e){const e={tag:(null===(o=t.tagName)||void 0===o?void 0:o.toLowerCase())||'',node:t,parent:n},r=t instanceof Element?t.getAttribute('_key'):null;null!=r&&(e.key=r,(s[e.tag]||(s[e.tag]=[])).push(e)),n.children.push(e),t.childNodes[0]&&d.push([[...t.childNodes],e])}d[0]&&(r=d.concat(r.slice(i)),i=0)}}return{vRoot:n,vKeyedByTags:s}}static flattenVirtualItems(e){let t,o=[e],n=0;for(;t=o[n++];)t.children&&t.children[0]&&(o=o.slice(0,n).concat(t.children.concat(o.slice(n))));return o}static getVirtualDomPairs(e,t,o){const{vRoot:n,vKeyedByTags:s,validator:r,suggester:i}=t,d=t.reused||new Set;let a,l=[],c=[[e,n||null]],u=0;for(;a=c[u++];){let[e,t]=a;if('dom'===e.type){const n=HostRender.getTreeNodeMatch(e,t,s,d,r,i);if(n){let o;n instanceof Node?(o=n,l.push([e,null,n])):(t=n,o=t.node),l.push([e,n===o?null:n,o]),d.add(o)}else o||l.push([e,t,null]),e.domNode&&d.add(e.domNode)}e.children[0]&&(c=e.children.map((e=>[e,t])).concat(c.slice(u)),u=0)}return l}static getTreeNodeMatch(e,t,o,n,s,r){const i=e.def.tag,d=e.def.key;if(r){const o=r(t,e,i,d);if(o){if((o instanceof Element?o.tagName.toLowerCase():'')===i&&(o instanceof Node?!(null==n?void 0:n.has(o)):!(null==n?void 0:n.has(o.node))&&HostRender.isVirtualItemOk(e,o,t,s)))return o}}const a=null!=d;if(t)for(const o of t.children?[t,...t.children]:[t])if(!o.used&&o.tag===i&&(a?o.key===d:null==o.key)&&!(null==n?void 0:n.has(o.node))&&(!s||s(o,e,i,d)))return o;if(o&&a){const r=o[i];if(r)for(const o of r)if(!o.used&&o.key===d&&!(null==n?void 0:n.has(o.node))&&HostRender.isVirtualItemOk(e,o,t,s))return o}return null}static isVirtualItemOk(e,t,o,n){if(t.tag!==e.def.tag)return!1;const s=e.def;if(o){let r=t;for(;r;){if(r===o)return!n||n(t,e,s.tag,s.key);r=r.parent}}else if(!n||n(t,e,s.tag,s.key))return!0;return!1}}function mergeChangesTo(e,...t){for(const o of t)o&&o[0][0]&&(e[0]=e[0].concat(o[0])),o&&o[1][0]&&(e[1]=e[1].concat(o[1]))}function sortBoundaries(e){const t=new Map;for(const o of e){let e=o.bId,n=o.parentBoundary;for(;n;)e=(n.bId||'')+'>'+e,n=n.parentBoundary;const s=t.get(e);if(s){let e=0;if(o.parentBoundary){const t=o.parentBoundary.innerBoundaries,n=t.indexOf(o);for(const o of s){if(n<t.indexOf(o))break;e++}}s.splice(e,0,o)}else t.set(e,[o])}const o=[];for(const e of t.keys()){let t=0,n=!1;for(const s of o){if(s.startsWith(e+'>'))break;if(e.startsWith(s+'>'))n=!0;else if(n)break;t++}o.splice(t,0,e)}let n=0;const s=[];for(const e of o)for(const o of t.get(e))s[n++]=o;return s}function updatedInterestedInClosure(e,t=!0){let o=[[],[]];for(const n of t&&e.size>1?sortBoundaries(e):e){if(!n._forceUpdate&&!n.component.lastState&&n.component.props===n._outerDef.props)continue;const e=n.host.services.updateBoundary(n);e&&mergeChangesTo(o,e)}return o}function collectInterestedInClosure(e,t){if(t){const e=new Set;if(t.closure.withContents)for(const o of t.closure.withContents)e.add(o);for(const o of t.constructor.WithContent.withContents)e.add(o);return e.size?e:null}if(!e.withContents&&!e.chainedClosures)return null;const o=e.withContents?new Set(e.withContents):new Set;if(e.chainedClosures)for(const t of e.chainedClosures){const e=collectInterestedInClosure(t);if(e)for(const t of e)o.add(t)}return o.size?o:null}HostRender.PASSING_TYPES={boundary:!0,pass:!0,host:!0,fragment:!0};const M={fragment:1,portal:2,pass:3,host:4};function assignTreeNodesFor(e,t,o,n,s){t.children[0]&&(t.children=[]);const r=e.length;if(!r)return[];const i=[];let d=0,a=null,l=t;if(o){if(!t.parent)return[];if(l=t.parent,a=t,d=l.children.indexOf(t),-1===d)return[]}for(let t=0;t<r;t++){const o=e[t];if(o.disabled){d--,i.push(null);continue}let r=null;o.treeNode?r=o.treeNode:'fragment'!==o.MIX_DOM_DEF&&(o.action='mounted'),a&&(r?l.children.splice(d,1):r=a,a=null);const c=o.MIX_DOM_DEF,u='content'===c||'element'===c?'dom':'fragment'===c?'':c;if(r){if(r.parent){const e=r.parent.children.indexOf(r);0===e&&r.parent!==l&&!0===HostRender.PASSING_TYPES[r.parent.type]&&s&&-1===s.indexOf(r.parent)&&s.push(r.parent),-1!==e&&r.parent.children.splice(e,1)}r.parent=l,r.sourceBoundary=n||null,r.type=u}else r={type:u,parent:l,children:[],sourceBoundary:n||null,domNode:null},'dom'===r.type&&(r.domProps={});'fragment'!==o.MIX_DOM_DEF&&(r.def=o,o.treeNode=r),l.children.splice(d+t,0,r),i.push(r)}return i}function findAppliedDefsFor(e,t,o,n,s,r,i){var d,a,l,c,u,f;let h=t.childDefs.length;if(!h)return[];const m=r||!t.isArray;if(!r&&t.isArray!=(e&&e.isArray))return t.childDefs.map((e=>newAppliedDef(e,s&&s.closure||null)));const g=e&&e.childDefs||null,y=[];for(let r=0;r<h;r++){const h=t.childDefs[r],C=null!=h.key,D=h.MIX_DOM_DEF,b=h.getRemote||M[D]||h.tag;let v=!1,N=null;if(g)for(const e of g)if((C?e.key===h.key:null==e.key)&&b===(e.getRemote||M[e.MIX_DOM_DEF]||e.tag)&&n.has(e)&&('boundary'!==D||!(null===(l=null===(a=null===(d=e.treeNode)||void 0===d?void 0:d.boundary)||void 0===a?void 0:a.component)||void 0===l?void 0:l.constantProps)||p(h.props,e.props,e.treeNode.boundary.component.constantProps))){N=e,n.delete(e),N.updateId&&N.updateId!==i&&delete N.updateId;break}if(!N&&C&&m){const e=o&&o.get(b);if(e)for(const t of e)if(t.key===h.key&&n.has(t)&&('boundary'!==D||!(null===(f=null===(u=null===(c=t.treeNode)||void 0===c?void 0:c.boundary)||void 0===u?void 0:u.component)||void 0===f?void 0:f.constantProps)||p(h.props,t.props,t.treeNode.boundary.component.constantProps))){N=t,n.delete(t),v=!0;for(const e of allDefsIn(N))e.updateId=i;break}}N?N.action=v||!e||e.childDefs[r]!==N?'moved':'updated':N=newAppliedDef(h,s&&s.closure||null),y.push(N)}return y}function buildDefMaps(e,t=!1,o=new Set,n){const s=new Map;let r,i=t?e.childDefs.slice():[e],d=0;for(;r=i[d];){d++,o.add(r);const e=r.getRemote||M[r.MIX_DOM_DEF]||r.tag,t=s.get(e);if(t?t.push(r):s.set(e,[r]),r.scopeType)if('spread-pass'===r.scopeType)n&&n.push(r);else{const e=[];r.scopeMap=buildDefMaps(r,!0,o,e)[0],e[0]&&(i=e[0].childDefs.concat(i.slice(d)),d=0)}else r.childDefs[0]&&(i=r.childDefs.concat(i.slice(d)),d=0)}return[s,o]}function runPassUpdate(e,t=!1){const[o,n,s]=function assignTreeNodesForPass(e){const t=e._innerDef,o=e.sourceBoundary,n=[],s=[],r=[];let i,d=[[e.targetDef,t,e.treeNode,!1]],a=0;for(;i=d[a];){a++;const[e,t,l,c]=i;if(t.childDefs[0]){const r=l&&'boundary'!==e.MIX_DOM_DEF&&('element'!==e.MIX_DOM_DEF||e.domElement)?assignTreeNodesFor(t.childDefs,l,c,o,s):[];let i=0;const u=[];for(const o of t.childDefs){const t=r[i]||null;!t&&o.treeNode&&(n.push(o.treeNode),o.treeNode.sourceBoundary=null),u.push([e.childDefs[i],o,t,'fragment'===o.MIX_DOM_DEF]),i++}d=u.concat(d.slice(a)),a=0}l&&!t.disabled&&r.push([e,t,l])}return[r,n,s]}(e);let[r,i]=applyDefPairs(e,o,t);if(n[0]){const e=new Set;for(const t of n)t.sourceBoundary||(t.def&&e.add(t.def),t.parent=null);if(e.size){const t=cleanUpDefs(e);r=t[0].concat(r),i=t[1].concat(i)}}return s[0]&&(r=s.map((e=>({treeNode:e,emptyMove:!0}))).concat(r)),e.isMounted=!0,[r,i]}function runBoundaryUpdate(e,t=!1){let o,n,s=null,r=e._innerDef;e.bId?(s=newDefFrom(e.render()),s&&!r&&(r=newAppliedDef(s,e.closure))):s=e.targetDef;const[i,d]=r?buildDefMaps(r):[new Map,new Set],a=[];if(s){const l=[],c=function pairDefs(e,t,o,n,s,r,i){const d=e.host.settings,a=d.noRenderValuesMode,l=d.wideKeysInArrays,c=[],u=e.bId?e:e.sourceBoundary;let f,p=[[{childDefs:[t]},{childDefs:[o]},e.treeNode,!1,null]],h=0;for(;f=p[h];){h++;const[t,o,d,m]=f,g='spread-pass'===o.scopeType?void 0:o.scopeMap||f[5];if(t.childDefs[0]){const c=findAppliedDefsFor(o,t,g||n,s,u,l,e.host.services._whileUpdating);o.childDefs=c;for(let e,n=0;e=t.childDefs[n];n++)if('content'===e.MIX_DOM_DEF){const t=o.childDefs[n];a&&(!0===a?!e.domContent:-1!==a.indexOf(e.domContent))?t.disabled=!0:delete t.disabled}const y='boundary'===t.MIX_DOM_DEF,C=f[4]||y&&o;y&&delete o.hasPassWithin;const D=!d||y||'element'===t.MIX_DOM_DEF&&!t.domElement?[]:assignTreeNodesFor(c,d,m,u,i),M=[];for(let e,o=0;e=t.childDefs[o];o++){const t=D[o]||null,n=c[o];!t&&n.treeNode&&(n.treeNode.sourceBoundary=null,r&&r.push(n)),C&&'pass'===e.MIX_DOM_DEF&&(C.hasPassWithin=!0);const s=[e,n,t,'fragment'===e.MIX_DOM_DEF,C||'boundary'===e.MIX_DOM_DEF&&n||null];M.push(s),g&&(s[5]=g)}p=M.concat(p.slice(h)),h=0}else o.childDefs=[];d&&t.MIX_DOM_DEF&&o.MIX_DOM_DEF&&c.push([t,o,d])}return c}(e,s,r,i,d,l,a);if(e._innerDef=c[0][1],[o,n]=applyDefPairs(e,c,t),l[0])for(const e of l){const t=e.treeNode;t&&null===t.sourceBoundary&&d.add(e)}}else o=[],n=[],!r&&e.isMounted||a.push(e.treeNode),e.innerBoundaries=[],e.treeNode.children=[],e._innerDef=null;if(d.size){const e=cleanUpDefs(d);o=e[0].concat(o),n=e[1].concat(n)}return a[0]&&(o=a.map((e=>({treeNode:e,emptyMove:!0}))).concat(o)),e.isMounted||(e.isMounted=!0),[o,n]}function applyDefPairs(e,t,o=!1){var n,s;const r=e.bId?e:e.sourceBoundary,i=[],d=e.host.settings.preCompareDOMProps;e.innerBoundaries=[];let a=[[],[]];for(const l of t){const[t,c,p]=l,h='mounted'===c.action;if(!h&&'moved'===c.action)switch(c.MIX_DOM_DEF){case'fragment':for(const e of rootDOMTreeNodes(p,!0,!0))-1===i.indexOf(e)&&(i.push(e),a[0].push({treeNode:e,move:!0}));break;case'host':c.host&&c.host.groundedTree.parent===p&&a[0].push({treeNode:p,move:!0})}if('fragment'===c.MIX_DOM_DEF)continue;if('pass'===p.type){if('pass'!==c.MIX_DOM_DEF)continue;let t=C.key;if(c.getRemote){const o=c.getRemote();t=null===(n=o.Content)||void 0===n?void 0:n.key,mergeChangesTo(a,groundClosureContent(o.closure,c,e,p,c.key!==t?c.key:null))}else c.contentPass&&mergeChangesTo(a,groundClosureContent(c.contentPass,c,e,p,c.key!==t?c.key:null));p.boundary&&e.innerBoundaries.push(p.boundary);continue}const m=c.props;let g=!1;t.props&&(p.boundary&&(p.boundary._outerDef.props=t.props),c.props=t.props||{});let y=!1;switch(c.MIX_DOM_DEF){case'content':y=!0;const o=t.domHTMLMode;g=c.domContent!==t.domContent||o!==t.domHTMLMode,g&&(c.domContent=t.domContent,void 0!==o?c.domHTMLMode=o:delete c.domHTMLMode);break;case'element':y=!0,c.domElement!==t.domElement&&(h||a[0].push({treeNode:p,swap:!0}),c.domElement=t.domElement||null),c.domCloneMode=null!=t.domCloneMode?t.domCloneMode:null;break;case'dom':y=!0;break;case'portal':c.domPortal!==t.domPortal&&(a[0].push({treeNode:p,[h?'create':'swap']:!0}),c.domPortal=t.domPortal||null);break;case'boundary':if(h){t.attachedContexts&&(c.attachedContexts=t.attachedContexts);const o=new SourceBoundary(e.host,c,p,r);o.parentBoundary=e,p.boundary=o}break;case'host':if(c.host){const e=c.host;let t=e;if('mounted'===c.action){if(e.groundedTree.parent){const o=t.settings.duplicatableHost;if('function'==typeof o){const e=o(c.host,p);if(!e)break;if('object'==typeof e){if(e.groundedTree.parent)break;t=e}}else if(!o)break;const n=e.shadowAPI;t===e?t=new e.constructor(e.services.getRootDef(!0),null,e.settings,null,n):t.shadowAPI!==e.shadowAPI&&(t.shadowAPI.hosts.delete(t),t.shadowAPI=e.shadowAPI);for(const e in n.contexts){const o=n.contexts[e];o&&t.contextAPI.setContext(e,o,!1)}c.host=t}e.shadowAPI.hosts.add(t)}t.groundedTree.parent=p,p.children=[t.groundedTree],a[0].push({treeNode:p,move:!0});break}}if(y){if(h)a[0].push({treeNode:p,create:!0});else{const e='moved'===c.action&&-1===i.indexOf(p),o=!!c.tag&&(!d||'if-needed'===d&&(g||e)||!u(m||{},t.props||{}));if(o||g||e){const t={treeNode:p};o&&(t.update=!0),g&&(t.content=!0),e&&(t.move=!0,i.push(p)),a[0].push(t)}}c.attachedSignals!==t.attachedSignals&&(t.attachedSignals?c.attachedSignals=t.attachedSignals:delete c.attachedSignals)}if(p.boundary){const n=p.boundary;if(e.innerBoundaries.push(n),h){if(c.tag&&c.tag._WithContent){const e=c.tag._WithContent,t=e.getRemote?e.getRemote().closure:r.closure;(t.withContents||(t.withContents=new Set)).add(n)}n.reattach()}const d=n.component;if(c.attachedSignals!==t.attachedSignals){const e=f(c.attachedSignals||{},t.attachedSignals||{});if(e)for(const t in e)e[t]?d.listenTo(t,e[t]):d.unlistenTo(t,c.attachedSignals[t]);c.attachedSignals=t.attachedSignals}if(c.attachedContexts!==t.attachedContexts){if(d.contextAPI){const e=f(c.attachedSignals||{},t.attachedSignals||{});if(e){for(const t in e)e[t]?d.contextAPI.setContext(t,e[t]):d.contextAPI.setContext(t,null);d.contextAPI.callDataBy(h||Object.keys(e))}}c.attachedContexts=t.attachedContexts}let l=null;const u=n.closure.envelope;t.childDefs[0]&&(l=u?{applied:Object.assign(Object.assign({},u.applied),{childDefs:c.childDefs,action:c.action}),target:Object.assign(Object.assign({},u.target),{childDefs:t.childDefs})}:{applied:{tag:null,MIX_DOM_DEF:'fragment',childDefs:c.childDefs,action:'mounted'},target:{tag:null,MIX_DOM_DEF:'fragment',childDefs:t.childDefs}});const m=u||l?n.closure:null;let g=null;if(m){g=preRefreshClosure(m,l);const e=r.closure;c.hasPassWithin?(e.chainedClosures||(e.chainedClosures=new Set)).add(m):null===(s=e.chainedClosures)||void 0===s||s.delete(m)}mergeChangesTo(a,e.host.services.updateBoundary(n,o,i,g)),m&&mergeChangesTo(a,applyClosureRefresh(m,o))}if(c.attachedRefs||t.attachedRefs){const e=c.attachedRefs,o=t.attachedRefs;if(e)for(const t of e)o&&o.includes(t)||Ref.willDetachFrom(t,p);if(o)for(const t of o)e&&e.includes(t)||Ref.didAttachOn(t,p);c.attachedRefs=o}}return a}function cleanUpDefs(e,t=!0,o=!0){var n,s;let r=[[],[]];for(const i of e){const e=i.treeNode;if(e){switch(i.MIX_DOM_DEF){case'dom':case'element':case'content':o&&r[0].push({treeNode:e,remove:!0});break;case'boundary':e.boundary&&mergeChangesTo(r,destroyBoundary(e.boundary,!1,o));break;case'pass':(i.contentPass||i.getRemote)&&mergeChangesTo(r,ungroundClosureContent(i.contentPass||i.getRemote().closure,i));case'host':{const t=i.host;if(t&&t.groundedTree.parent===e){t.groundedTree.parent=null,e.children=[],r[0].push({treeNode:e,move:!0}),t.shadowAPI.hosts.delete(t);const o=t.contextAPI;for(const e in o.contexts)null===(n=o.contexts[e])||void 0===n||n.contextAPIs.delete(o)}}default:if(i.attachedRefs&&i.MIX_DOM_DEF)for(const t of i.attachedRefs)Ref.willDetachFrom(t,e)}t&&('pass'===(null===(s=e.parent)||void 0===s?void 0:s.type)&&e.parent.def.getRemote&&r[0].push({emptyMove:!0,treeNode:e.parent}),e.parent=null,e.sourceBoundary=null,delete i.treeNode)}}return r}function destroyBoundary(e,t=!0,n=!0){var s,r,i,d;let a=[[],[]];if(null===e.isMounted)return a;const l=e.bId?e:null;if(l){const e=l.component,t=e.constructor;e.signals.willUnmount&&o(e.signals.willUnmount);const n=l._outerDef;if(n.attachedRefs)for(const e of n.attachedRefs)Ref.willDetachFrom(e,l.treeNode);null===(r=null===(s=l.sourceBoundary)||void 0===s?void 0:s.closure.chainedClosures)||void 0===r||r.delete(l.closure);const c=e.contextAPI;if(c){for(const e in c.contexts)null===(i=c.contexts[e])||void 0===i||i.contextAPIs.delete(c);c.contexts={},l.host.contextComponents.delete(e)}if(t.api&&(t.api.components.delete(e),t.api.signals&&(t.api.signals={})),'Remote'===t.MIX_DOM_CLASS&&mergeChangesTo(a,t.removeSource(e)),n.tag._WithContent){const e=n.tag._WithContent,t=e.getRemote?e.getRemote().closure:null===(d=l.sourceBoundary)||void 0===d?void 0:d.closure;(null==t?void 0:t.withContents)&&(t.withContents.delete(l),t.withContents.size||delete t.withContents)}e.signals&&(e.signals={}),e.timers&&e.clearTimers()}return n&&(a[0]=a[0].concat(rootDOMTreeNodes(e.treeNode,!0).map((e=>({treeNode:e,remove:!0}))))),e._innerDef&&mergeChangesTo(a,cleanUpDefs(allDefsIn(e._innerDef,!0),t,!1)),l&&l.host.services.cancelUpdates(l),e.isMounted=null,a}function groundClosureContent(e,t,o,n,s){return e.groundedDefs.get(t)?'moved'===t.action&&n.boundary?[rootDOMTreeNodes(n.boundary.treeNode,!0,!0).map((e=>({treeNode:e,move:!0}))),[]]:[[],[]]:(e.groundedDefs.set(t,[o,n,s]),applyContentDefs(e,[t]))}function ungroundClosureContent(e,t){const o=e.groundedDefs.get(t);if(!o)return[[],[]];e.groundedDefs.delete(t),e.pendingDefs.delete(t),e.truePassDef===t&&(e.truePassDef=null);const n=o[1].boundary;return n?destroyBoundary(n):[[],[]]}function preRefreshClosure(e,t,o){if(e.remote)return e.envelope=t,preRefreshClosure(e.remote.closure,t,e.remote);if(!e.envelope&&!t)return null;const n=collectInterestedInClosure(e,o);if(n)for(const e of n)e._forceUpdate=e._forceUpdate||!0;return e.envelope=t,e.pendingDefs=new Set(e.groundedDefs.keys()),n}function applyClosureRefresh(e,t=!1){if(e.remote)return applyClosureRefresh(e.remote.closure,t);let o=[],n=[];return e.pendingDefs.size&&([o,n]=applyContentDefs(e,e.pendingDefs,t)),[o,n]}function applyContentDefs(e,t,o=!1){let n=[],s=[];for(const r of t){e.pendingDefs.delete(r);const t=e.groundedDefs.get(r);if(void 0===t)continue;let[i,d,a]=t,l=d.boundary;if(e.envelope&&e.sourceBoundary){let t=!0;const c=e.envelope;l?(t=e.truePassDef===r,l.updateEnvelope(c.target,t?c.applied:null)):(l=new ContentBoundary(r,c.target,d,e.sourceBoundary),t=null==a&&(!e.truePassDef||e.truePassDef===r),t&&(l._innerDef.childDefs=c.applied.childDefs,e.truePassDef=r),l.parentBoundary=i,d.boundary=l);const[u,f]=t?runPassUpdate(l,o):runBoundaryUpdate(l,o);n=n.concat(u),s=s.concat(f)}else if(l){const e=destroyBoundary(l,!1);n=n.concat(e[0]),s=s.concat(e[1]),d.boundary=null}}return[n,s]}class HostServices{constructor(e){this.host=e,this.bIdCount=0,this.renderer=new HostRender(e.settings,e.groundedTree),this.updateCycle=new r({initPending:()=>({updates:new Set})}),this.renderCycle=new r({initPending:()=>({rCalls:[],rInfos:[]}),autoRenewPromise:!0}),this.constructor.initializeCyclesFor(this)}createBoundaryId(){return'h-'+this.host.constructor.idCount.toString()+':b-'+(this.bIdCount++).toString()}clearTimers(e=!1){e||(this.updateCycle.resolve(),this.renderCycle.resolve()),this.updateCycle.reject(),this.renderCycle.reject()}createRoot(e){return this.rootDef=newDefFrom(e),(e,t)=>()=>this._rootDisabled?null:this.rootDef}updateRoot(e,t,o){this.rootDef=newDefFrom(e),this.host.rootBoundary.update(!0,t,o)}refreshRoot(e=!1,t,o){const n=!this._rootDisabled,s=this.host,r=!(s.settings.onlyRunInContainer&&!s.groundedTree.domNode&&!s.groundedTree.parent);if(r?delete this._rootDisabled:this._rootDisabled=!0,!e&&r&&n){if(r&&n){const e=s.rootBoundary?rootDOMTreeNodes(s.rootBoundary.treeNode,!0).map((e=>({treeNode:e,move:!0}))):[];this.absorbChanges(e,null,o)}}else s.rootBoundary.update(!0,t,o)}clearRoot(e=!1){this.clearTimers(e),this.rootDef=null}getRootDef(e){return this.rootDef&&(e?Object.assign({},this.rootDef):this.rootDef)}hasPending(e=!0,t=!0){return!!(e&&this.updateCycle.state||t&&this.renderCycle.state)}addRefreshCall(e,t=!1){t?this.renderCycle.promise.then(e):this.updateCycle.promise.then(e)}cancelUpdates(e){var t;null===(t=this.updateCycle.pending.updates)||void 0===t||t.delete(e)}absorbUpdates(e,t,o=!0,n,s){if(null!==e.isMounted){if(t.force&&(e._forceUpdate='all'===e._forceUpdate?'all':t.force),t.props&&(e._outerDef.props=t.props),t.state){const o=e.component;o.lastState||(o.lastState=Object.assign({},o.state)),o.state=t.state}e._renderState?e._renderState='re-updated':(this.updateCycle.pending.updates.add(e),o&&this.triggerRefresh(n,s))}}triggerRefresh(e,t){this.updateRefreshTimes(e,t),this.updateCycle.trigger(this.host.settings.updateTimeout)}updateRefreshTimes(e,t){void 0!==e&&this.updateCycle.extend(e),void 0!==t&&this.renderCycle.extend(t)}updateBoundary(e,t=!1,n,r){let i=!!t,d='all'===t,a=[],l=[];const c=e.component,u=!e.isMounted;if(u){if(null===e.isMounted)return null;l.push([e,'mounted']),i=!0}const f=e._outerDef.props!==c.props?c.props||{}:void 0;f&&(c.props=e._outerDef.props);const p=c.constructor.api;if(p&&(u||f)&&(u&&p.onBuildProps&&!p.builtProps&&(p.builtProps=p.onBuildProps(null)),p.getMixedProps&&(u||c.lastState||(c.lastState=Object.assign({},c.state)),c.state=p.getMixedProps(c))),!u&&c.signals.beforeUpdate&&o(c.signals.beforeUpdate),e._forceUpdate&&('all'===e._forceUpdate&&(d=!0),i=!0,delete e._forceUpdate),!u){const t=c.lastState;if(delete c.lastState,i||f||t){if(!i){const o=c.signals.shouldUpdate?s(c.signals.shouldUpdate,[c,f,t],['first-true','no-false']):null;(!0===o||null==o&&HostServices.shouldUpdateBy(e,f,t))&&(i=!0)}const r='moved'===e._outerDef.action;if(r&&l.push([e,'moved']),i&&l.push([e,'updated',f,t]),r)for(const t of rootDOMTreeNodes(e.treeNode,!0,!0)){if(n){if(-1!==n.indexOf(t))continue;n.push(t)}a.push({treeNode:t,move:!0})}c.signals.preUpdate&&o(c.signals.preUpdate,[f,t,i])}}if(i){const[t,o]=runBoundaryUpdate(e,d);a=a.concat(t),l=l.concat(o)}if(c.wired)for(const e of c.wired){if(e.api.onBuildProps){const t=e.api.builtProps;if(e.api.builtProps=e.api.onBuildProps(t),t===e.api.builtProps)continue}if(e.api.components.size){r||(r=new Set);for(const t of e.api.components)t.boundary._outerDef.props=Object.assign({},t.boundary._outerDef.props),r.add(t.boundary)}}if(r&&r.size){for(const t of r)t.sourceBoundary===e.sourceBoundary&&t._updateId!==e.host.services._whileUpdating&&(t._forceUpdate=!0,r.delete(t));const t=updatedInterestedInClosure(r,!0);a=a.concat(t[0]),l=l.concat(t[1])}return a[0]||l[0]?[a,l]:null}absorbChanges(e,t,o){var n;e&&this.renderCycle.pending.rInfos.push(e),t&&(this.host.settings.useImmediateCalls?HostServices.callBoundariesBy(t):this.renderCycle.pending.rCalls.push(t)),this.renderCycle.trigger(null!==(n=this.host.settings.renderTimeout)&&void 0!==n?n:void 0,null!=o?o:void 0)}static initializeCyclesFor(e){e.updateCycle.listenTo('onRefresh',((t,o)=>e.constructor.runUpdates(e,t,o))),e.renderCycle.listenTo('onRefresh',((t,o)=>e.constructor.runRenders(e,t,o))),e.updateCycle.listenTo('onFinish',(()=>{e.renderCycle.trigger(e.host.settings.renderTimeout)})),e.renderCycle.listenTo('onResolve',(()=>e.updateCycle.resolve()))}static runUpdates(e,t,o){if(!e._whileUpdating){for(;t.updates.size;){e._whileUpdating={};let o=[],n=[];for(const s of t.updates.size>1?sortBoundaries(t.updates):[...t.updates]){s._updateId=e._whileUpdating;const t=e.updateBoundary(s);t&&(o=o.concat(t[0]),n=n.concat(t[1]))}o[0]&&e.renderCycle.pending.rInfos.push(o),n[0]&&(e.host.settings.useImmediateCalls?HostServices.callBoundariesBy(n):e.renderCycle.pending.rCalls.push(n)),t=e.updateCycle.resetPending()}delete e._whileUpdating}}static runRenders(e,t,o){if(t.rInfos)for(const o of t.rInfos)o[0]&&e.renderer.applyToDOM(o);if(t.rCalls)for(const e of t.rCalls)e[0]&&HostServices.callBoundariesBy(e)}static shouldUpdateBy(e,t,o){var n,s,r;const i=e.component,d=e.host.settings.updateComponentModes,a=null===(n=i.constructor.api)||void 0===n?void 0:n.updateModes,l=t&&o?['props','state']:t?['props']:o?['state']:[];for(const e of l){const n=null!==(r=null!==(s=i.updateModes&&i.updateModes[e])&&void 0!==s?s:a&&a[e])&&void 0!==r?r:d[e],l='number'==typeof n?n:h[n]||0;if(l<-1){if(-2===l)return!0}else{if(0===l)return!0;if(!m('state'===e?o:t,i[e],l))return!0}}return!1}static callBoundariesBy(e){for(const t of e){const[e,n,s,r]=t,i=e.component,d='mounted'===n?'didMount':'moved'===n?'didMove':'didUpdate';i.signals[d]&&o(i.signals[d],'updated'===n?[s,r]:void 0)}}}class Host{constructor(e,t,o,n,s){this.constructor.idCount++,this.shadowAPI=s||new HostShadowAPI,this.contextComponents=new Set,this.contextAPI=new HostContextAPI,this.contextAPI.host=this,n&&this.contextAPI.setContexts(n,!1,!0),this.groundedTree={type:'root',parent:null,children:[],domNode:t||null,sourceBoundary:null},this.settings=Host.getDefaultSettings(),o&&Host.modifySettings(this.settings,o),this.services=new HostServices(this);const r=newAppliedDef({MIX_DOM_DEF:'boundary',tag:this.services.createRoot(e),props:{},childDefs:[]},null),i={type:'boundary',def:r,sourceBoundary:null,boundary:null,parent:this.groundedTree,children:[],domNode:null};this.groundedTree.children.push(i),this.rootBoundary=new SourceBoundary(this,r,i),i.boundary=this.rootBoundary,this.rootBoundary.reattach(),this.services.absorbUpdates(this.rootBoundary,{})}clearRoot(e=!0,t,o){this.services.clearRoot(!0),e&&this.rootBoundary.update(!0,t,o)}moveRoot(e,t){if(this.groundedTree.domNode===e)return;this.groundedTree.domNode=e;const o=rootDOMTreeNodes(this.rootBoundary.treeNode,!0).map((e=>({treeNode:e,move:!0})));(o[0]||void 0!==t)&&this.services.absorbChanges(o,null,t)}updateRoot(e,t,o){this.services.updateRoot(e,t,o)}refreshRoot(e=!1,t,o){this.services.refreshRoot(e,t,o)}refreshDOM(e=!1,t){const o=!e||'read',n=[];let s,r=[...this.groundedTree.children],i=0;for(;s=r[i];)i+=1,s.domProps&&n.push({treeNode:s,refresh:o}),s.children[0]&&(r=s.children.concat(r.slice(i)),i=0);this.services.absorbChanges(n,null,t)}afterRefresh(e=!1,t,o){return new Promise((n=>this.afterRefreshCall(n,e,t,o)))}updateRefreshTimes(e,t){this.services.updateRefreshTimes(e,t)}afterRefreshCall(e,t=!1,o,n){this.services.hasPending(!0,t)?(this.addRefreshCall(e,t),this.services.triggerRefresh(o,n)):e()}addRefreshCall(e,t=!1){this.services.addRefreshCall(e,t)}triggerRefresh(e,t){this.services.triggerRefresh(e,t)}pause(){this.services.renderer.pause()}resume(){this.services.renderer.resume()}isPaused(){return this.services.renderer.paused}reassimilate(e=null,t=!1,o=!1,n=!1,s,r){this.services.renderer.reassimilate(e||this.groundedTree.domNode,t,o,n,s,r)}reassimilateWith(e,t=null,o=!1,n=!1,s=!1,r,i){this.pause(),this.updateRoot(e,null,null),this.services.renderer.reassimilate(t||this.groundedTree.domNode,o,n,s,r,i)}remount(e=null,t=!1,o=!0,n,s){return this.remountWith(this.services.getRootDef(!0),e,t,o,n,s)}remountWith(e,t=null,o=!1,n=!0,s,r){null==e&&(e=this.services.getRootDef(!0));const i=t&&HostRender.createVirtualItemsFor(t);this.clearRoot(!0,null,null);const d=this.settings.debugMode||void 0,a=this.services.renderer,l=a.sourceRemount=i?Object.assign(Object.assign({},i),{reused:d&&new Set,created:d&&new Set,unused:d&&new Set,readFromDOM:o,removeUnused:n,validator:s,suggester:r}):void 0;if(this.services.updateRoot(e,null,null),delete a.sourceRemount,d&&l)return{created:l.created,reused:l.reused,unused:l.unused}}readDOMString(){return HostRender.readDOMString(this.rootBoundary.treeNode)}getRootDef(){return this.services.getRootDef(!0)}getContainerElement(){return this.groundedTree.domNode}getRootElement(){return this.rootBoundary&&this.rootBoundary.treeNode.domNode}getRootElements(e){return this.rootBoundary?rootDOMTreeNodes(this.rootBoundary.treeNode,e,!1).map((e=>e.domNode)):[]}queryElement(e,t=!1){return domElementByQuery(this.groundedTree,e,!0,t)}queryElements(e,t=0,o=!1){return domElementsByQuery(this.groundedTree,e,t,!0,o)}findElements(e=0,t=!1,o){return treeNodesWithin(this.groundedTree,new Set(['dom']),e,!0,t,o).map((e=>e.domNode))}findComponents(e=0,t=!1,o){return treeNodesWithin(this.groundedTree,new Set(['boundary']),e,!0,t,o).map((e=>e.boundary&&e.boundary.component))}findTreeNodes(e,t=0,o=!1,n){const s=e.constructor===Set?e:e.constructor===Array?new Set(e):new Set(Object.keys(e));return treeNodesWithin(this.groundedTree,s,t,!0,o,n)}modifySettings(e,t=!0){const o=this.settings.onlyRunInContainer;if(Host.modifySettings(this.settings,e),void 0!==e.onlyRunInContainer&&e.onlyRunInContainer!==o&&this.refreshRoot(!1,null,null),t)for(const t of this.shadowAPI.hosts)t!==this&&t.modifySettings(e,!1)}static modifySettings(e,t,o=!1){var n;let s=null;if(t.updateComponentModes){const e=t.updateComponentModes,o={};for(const t in e)o[t]=null!==(n=e[t])&&void 0!==n?n:(s||(s=Host.getDefaultSettings())).updateComponentModes[t];t=Object.assign(Object.assign({},t),{updateComponentModes:o})}for(const n in t)void 0!==t[n]?e[n]=t[n]:o&&(e[n]=(s||(s=Host.getDefaultSettings()))[n])}static getDefaultSettings(){return{updateTimeout:0,renderTimeout:0,useImmediateCalls:!1,updateComponentModes:{props:'shallow',state:'shallow'},preCompareDOMProps:'if-needed',wideKeysInArrays:!1,noRenderValuesMode:!1,onlyRunInContainer:!1,disableRendering:!1,duplicateDOMNodeBehaviour:'deep',duplicateDOMNodeHandler:null,duplicatableHost:!1,maxReRenders:1,renderTextTag:'',renderHTMLDefTag:'span',renderTextHandler:null,renderSVGNamespaceURI:'http://www.w3.org/2000/svg',renderDOMPropsOnSwap:!0,debugMode:!1}}}Host.MIX_DOM_CLASS='Host',Host.idCount=0;class PseudoFragment{constructor(e){}}PseudoFragment.MIX_DOM_CLASS='Fragment';class PseudoPortal{constructor(e){}}PseudoPortal.MIX_DOM_CLASS='Portal';class PseudoElement{constructor(e){}}PseudoElement.MIX_DOM_CLASS='Element';class PseudoEmpty{constructor(e){}render(){return null}}PseudoEmpty.MIX_DOM_CLASS='Empty';class PseudoEmptyRemote extends PseudoEmpty{constructor(e,t){super(e,t)}static isRemote(){return!1}}PseudoEmptyRemote.MIX_DOM_CLASS='EmptyRemote',PseudoEmptyRemote.Content=null,PseudoEmptyRemote.ContentCopy=null,PseudoEmptyRemote.copyContent=e=>null,PseudoEmptyRemote.filterContent=(e,t)=>null,PseudoEmptyRemote.wrapContent=(e,t)=>null,PseudoEmptyRemote.renderContents=e=>null,PseudoEmptyRemote.hasContent=e=>!1,PseudoEmptyRemote.WithContent=(e,t)=>null,PseudoEmptyRemote.sources=[];class ComponentShadowAPI extends n{constructor(){super(...arguments),this.components=new Set}update(e=!0,t,o){for(const n of this.components)n.triggerUpdate(e,t,o)}static onListener(e,t,o,n){if(e.components.size&&e.signals[t]){const s=e.signals[t][o],r=s[0];if(n)for(const o of e.components)o.listenTo(t,((...e)=>s[1]?r(o,...e,...s[1]):r(o,...e)),null,s[2],r);else for(const o of e.components)o.unlistenTo(t,r)}}}function prepareShadow(e,t,o){if(o)for(const t in o)e[t]=o[t];if(e.api=new ComponentShadowAPI,t)for(const o in t)e.api.listenTo(o,t[o])}function createShadow(e,t,...o){const n=o[0]&&'object'==typeof o[0]?o[0]:void 0,s=(n?o[1]:o[0])||e.name,r=e.MIX_DOM_CLASS?{[s]:class extends e{}}[s]:createComponent(e,s);return prepareShadow(r,t,n),r}const createShadowCtx=(e,t,...o)=>{const n=o[0]&&'object'==typeof o[0]?o[0]:void 0,s=createComponentCtx(e,(n?o[1]:o[0])||e.name);return prepareShadow(s,t,n),s};class ComponentWiredAPI extends ComponentShadowAPI{constructor(){super(),this.updateModes={props:'never'},this.builtProps=null}buildProps(){return this.onBuildProps?this.onBuildProps(this.builtProps):this.builtProps}getMixedProps(e){return this.onMixProps?this.onMixProps(e.props,this.builtProps,e):Object.assign(Object.assign({},e.props),e.state)}setProps(e,t,o,n){(this.builtProps!==e||t||void 0!==o||void 0!==n)&&(this.builtProps=e,this.update('trigger'!==t&&t,o,n))}refresh(e,t,o){this.setProps(this.buildProps(),e,t,o)}update(e=!0,t,o){for(const n of this.components)n.setState(this.getMixedProps(n),e,t,o)}}function createWired(...e){const t=e.length,o='string'==typeof e[t-1]?-1:0,n=e[t-3+o],s=e[t-2+o]||null,r=e[t-1+o],i=o?e[t-1]:r.name,d={[i]:function(e,t){return newDef(r,Object.assign({},t.state),C)}}[i];return d.api=new ComponentWiredAPI,n&&('object'==typeof n?d.api.builtProps=n:t>2&&'function'==typeof n&&(d.api.onBuildProps=n)),s&&(d.api.onMixProps=s),d}const createRemote=()=>{var e,t;return e=class _Remote extends Component{constructor(){super(...arguments),this.closure=new ContentClosure(null,this.boundary),this.Content=Object.assign(Object.assign({},newContentPassDef(this)),{contentPass:null,getRemote:()=>this}),this.ContentCopy=Object.assign(Object.assign({},newContentPassDef(this,!0)),{contentPass:null,getRemote:()=>this}),this.copyContent=e=>Object.assign(Object.assign({},newContentPassDef(null!=e?e:_Remote,!0)),{contentPass:null,getRemote:()=>this}),this.hasContent=()=>this.closure.hasContent(),this.WithContent=(()=>{var e;const t=this;return(e=class WithContent extends Component{render(){return(null!=this.props.hasContent?this.props.hasContent:t.closure.hasContent())?C:null}})._WithContent=t.Content,e})()}render(){return null}static isRemote(){return!0}static addSource(e,t=e.props.order){const o=_Remote.sources.indexOf(e),n=g(t,_Remote.sources.map((e=>e.props.order)));if(-1===o);else{if(-1===n?o===_Remote.sources.length-1:o===n)return;_Remote.sources.splice(o,1)}-1===n?_Remote.sources.push(e):_Remote.sources.splice(n,0,e);for(const t of _Remote.passers)t.boundary.host===e.boundary.host?t.boundary.update(!0):t.boundary.host.addRefreshCall((()=>t.boundary.update(!0,null,null)),!0)}static removeSource(e){const t=_Remote.sources.indexOf(e);if(-1===t)return null;_Remote.sources.splice(t,1);let o=null;const n=collectInterestedInClosure(e.closure,e);o=function applyClosureEnvelope(e,t){const o=preRefreshClosure(e,t),n=o&&updatedInterestedInClosure(o),s=applyClosureRefresh(e);return n?[n[0].concat(s[0]),n[1].concat(s[1])]:s}(e.closure,null),e.closure.sourceBoundary=null;for(const t of _Remote.passers)t.boundary.host===e.boundary.host?t.boundary.update(!0):t.boundary.host.addRefreshCall((()=>t.boundary.update(!0,null,null)),!0);return n&&e.boundary.host.addRefreshCall((()=>{for(const e of n)e.update(!0,null,null)}),!0),o}},e.passers=new Set,e.ContentPasser=(t,o)=>(e.passers.add(o),o.listenTo('willUnmount',(()=>e.passers.delete(o))),t=>t.renderer?t.renderer(e.sources.slice()):{tag:null,MIX_DOM_DEF:'fragment',childDefs:t.wrapper?e.sources.map(((e,o)=>t.wrapper?newDefFrom(t.wrapper(e,o)):null!=t.copyKey?e.copyContent(t.copyKey):t.copy?e.ContentCopy:e.Content)).filter((e=>e)):(t.filterer?e.sources.filter(t.filterer):e.sources).map((e=>null!=t.copyKey?e.copyContent(t.copyKey):t.copy?e.ContentCopy:e.Content))}),e.MIX_DOM_CLASS='Remote',e.Content=newDef(e.ContentPasser),e.ContentCopy=newDef(e.ContentPasser,{copy:!0}),e.copyContent=t=>newDef(e.ContentPasser,{copy:!0,copyKey:t}),e.hasContent=t=>t?e.sources.some(((e,o)=>t(e,o)&&e.closure.hasContent())):e.sources.some((e=>e.closure.hasContent())),e.filterContent=(t,o)=>newDef(e.ContentPasser,{copyKey:o,filterer:t}),e.wrapContent=(t,o)=>newDef(e.ContentPasser,{copyKey:o,wrapper:t}),e.renderContents=t=>newDef(e.ContentPasser,{renderer:t}),e.WithContent=((t=class WithContent extends Component{constructor(e,t){super(e,t),WithContent.withContents.add(this.boundary),this.listenTo('willUnmount',(()=>WithContent.withContents.delete(this.boundary)))}render(){return(null!=this.props.hasContent?this.props.hasContent:e.hasContent())?C:null}})._WithContent=e.Content,t.withContents=new Set,t),e.sources=[],e};var b;const checkRecursively=e=>{var t;return!(!(null===(t=e.contentPass)||void 0===t?void 0:t.envelope)||!hasContentInDefs(e.contentPass.envelope.applied.childDefs,checkRecursively))},v=((b=class WithContent extends Component{hasContent(){var e;const t=null===(e=this.boundary.sourceBoundary)||void 0===e?void 0:e.closure;return t&&t.envelope&&hasContentInDefs(t.envelope.applied.childDefs,checkRecursively)||!1}render(){var e;return(null!==(e=this.props.hasContent)&&void 0!==e?e:this.hasContent())?C:null}})._WithContent=C,b);function mergeShadowWiredAPIs(e){const t=e.some((e=>e instanceof ComponentWiredAPI))?new ComponentWiredAPI:new ComponentShadowAPI;for(const o of e){if(o.updateModes){t.updateModes||(t.updateModes={});for(const e in o.updateModes)t.updateModes[e]=Object.assign(Object.assign({},t.updateModes[e]),o.updateModes[e])}for(const e in o.signals)t.signals[e]=[...t.signals[e]||[],...o.signals[e]];o instanceof ComponentWiredAPI&&(o.builtProps&&(t.builtProps=o.builtProps),o.onBuildProps&&(t.onBuildProps=o.onBuildProps),o.onMixProps&&(t.onMixProps=o.onMixProps))}return t}function mixFuncs(...e){const t=e.length,o=!0===e[t-1],n=o||!e[t-1]?e.slice(0,t-1):e,CompFunc=(e,t,s)=>{let r=null;for(const o of n){if(!o)continue;const n=t.state,i=o(e,t,s);'function'!=typeof i&&'function'==typeof r||(r=i),n!==t.state&&t.state&&(t.state=Object.assign(Object.assign({},n||{}),t.state))}return o?()=>r:r},s=n.some((e=>e.length>2))?(e,t,o)=>CompFunc(e,t,o):(e,t)=>CompFunc(e,t),r=[];for(const e of n)for(const t in e)'api'===t?r.push(e.api):s[t]=e[t];return r[0]&&(s.api=mergeShadowWiredAPIs(r)),s}function mixFuncsWith(...e){const t=e.length;return'function'!=typeof e[t-1]?mixFuncs(...e.slice(0,t-1),!0):mixFuncs(...e,!0)}function createMixin(e){return e}function mixMixins(...e){const t=e[0].MIX_DOM_CLASS?e[0]:null;let o=t||Component;for(const n of t?e.slice(1):e)o=n(o);return o}function mixMixinsWith(...e){const t=e.length;return'function'!=typeof e[t-1]?mixMixins(...e.slice(0,t-1)):mixMixins(e)}function mixClassMixins(...e){return mixMixins(...e)}function mixClassFuncs(e,...t){const o='function'!=typeof t[t.length-1]&&!!t.pop(),n=t.length>1?mixFuncs(...t):t[0],s={[e.name]:class extends e{render(e){const t=n(e,this,this.contextAPI);return o?super.render:'function'==typeof t?t:()=>t}}}[e.name];for(const e in n)'api'===e?s.api=s.api?mergeShadowWiredAPIs([s.api,n.api]):n.api:s[e]=n[e];return s}function mixClassFuncsWith(...e){const t=e.length;return mixClassFuncs(...'function'!=typeof e[t-1]?e.slice(0,t-1):e)}function mixHOCs(e,...t){let o=e;for(const e of t)o=e(o);return e=>newDef(o,e,C)}const N={def:newDef,defHTML:newDefHTML,Content:C,WithContent:v,ContentCopy:D,copyContent:function newContentCopyDef(e){return newContentPassDef(e,!0)},Component,Host,Ref,Fragment:PseudoFragment,Portal:PseudoPortal,Element:PseudoElement,Empty:PseudoEmpty,EmptyRemote:PseudoEmptyRemote,component:createComponent,componentCtx:createComponentCtx,shadow:createShadow,shadowCtx:createShadowCtx,spread:createSpread,spreadWith:createSpreadWith,remote:createRemote,wired:createWired,mixin:createMixin,mixinComponent,mixFuncs,mixFuncsWith,mixClassFuncs,mixClassFuncsWith,mixClassMixins,mixMixins,mixMixinsWith,mixHOCs,findTreeNodesIn:(e,t,o,n,s,r)=>treeNodesWithin(e,t?t.constructor===Set?t:t.constructor===Array?new Set(t):new Set(Object.keys(t)):void 0,o,n,s,r),findComponentsIn:(e,t,o,n,s)=>treeNodesWithin(e,new Set(['boundary']),t,o,n,s).map((e=>e.boundary&&e.boundary.component)),findElementsIn:(e,t,o,n,s)=>treeNodesWithin(e,new Set(['dom']),t,o,n,s).map((e=>e.domNode)),queryElementIn:(e,t,o,n)=>domElementByQuery(e,t,o,n),queryElementsIn:(e,t,o,n,s)=>domElementsByQuery(e,t,o,n,s),readDOMString:e=>{const t=e&&(e.constructor.MIX_DOM_CLASS?e.boundary.treeNode:e.treeNode||'string'==typeof e.type&&e);return t?HostRender.readDOMString(t):''}};export{Component,ComponentContextAPI,ComponentShadowAPI,ComponentWiredAPI,Host,HostContextAPI,N as MixDOM,C as MixDOMContent,D as MixDOMContentCopy,v as MixDOMWithContent,PseudoElement,PseudoEmpty,PseudoEmptyRemote,PseudoFragment,PseudoPortal,Ref,SourceBoundary,createComponent,createComponentCtx,createMixin,createRemote,createShadow,createShadowCtx,createSpread,createSpreadWith,createWired,mergeShadowWiredAPIs,mixClassFuncs,mixClassFuncsWith,mixClassMixins,mixFuncs,mixFuncsWith,mixHOCs,mixMixins,mixMixinsWith,mixinComponent,newDef,newDefHTML};
